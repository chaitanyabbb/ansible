# services.yml

---

- hosts: kube_masters
  remote_user: root
  tasks:
  - name: Pinging All Servers
    action: ping


  - name: Running Pre-Checks
    shell: curl -sL http://kickstart.mylab.local/index.sh | bash
    args:
      warn: false


  - name: Stop httpd Service
    service:
      name: httpd
      state: stopped
  
#  - name: Rebooting host(s)
#    shell: sleep 2 && /sbin/shutdown -r now "Reboot required for updated kernel." && sleep 2
#    async: 60
#    poll: 5

#  - name: Wait for the system to reboot
#    wait_for_connection:
#      connect_timeout: 300
#      sleep: 5
#      delay: 5
#      timeout: 300


  - name: restart system to reboot to newest kernel
    shell: "sleep 5 && reboot"
    async: 1
    poll: 0

#  - name: wait for 300 seconds
#    pause:
#      minutes: 10

  - name: wait for the system to reboot
    wait_for_connection:
      connect_timeout: 300
      sleep: 300
      delay: 300
      timeout: 300      

  - name: Running Post Script
    shell: curl -sL http://kickstart.mylab.local/index.sh | bash
    args:
      warn: false

  - name: Start httpd Service
    service: 
      name: httpd 
      state: started
